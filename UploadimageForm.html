
%%[

SET @SubscriberKey = _SubscriberKey

IF EMPTY(@SubscriberKey) THEN
  SET @SubscriberKey = RequestParameter('Contact_Id')
ENDIF

SET @Lease_Id = RequestParameter('Lease_Id')

IF EMPTY(@Lease_Id) OR EMPTY(@SubscriberKey) THEN
  Redirect('https://cloud.sfdc.msrenewal.com/SFMCerror')
ENDIF


]%%

<script runat="server">
  Platform.Load("Core","1.1.5");

  var isPost = (Platform.Request.Method == "POST");
  var resultMsg = "";
  var resultOk = false;

  if (isPost) {
    try {

      var randomID = Platform.Function.GUID();
      var fileName   = Platform.Request.GetFormField("fileName");
      var mimeType   = Platform.Request.GetFormField("mimeType");

      if (mimeType == "image/jpeg") {
            var fileName   = randomID + ".jpg"
        } else if (mimeType == "image/png") {
            var fileName   = randomID + ".png"
        } else {
            throw "Only JPG and PNG allowed";
        }


      var fileBase64 = Platform.Request.GetFormField("fileBase64");

      if (!fileName || !mimeType || !fileBase64) throw "Missing upload fields";
      if (mimeType != "image/jpeg" && mimeType != "image/png") throw "Only JPG/PNG allowed";

      // Optional: guard against huge payloads (base64 is larger than the binary)
      if (fileBase64.length > 6000000) throw "File too large";

      var payload = {
        fileName: fileName,
        mimeType: mimeType,
        fileBase64: fileBase64
      };

      var req = new Script.Util.HttpRequest("https://sfmc-box-upload-9f137793dd2b.herokuapp.com/upload");
      req.method = "POST";
      req.contentType = "application/json";
      req.setHeader("Accept", "application/json");
      req.setHeader("X-Upload-Secret", "scherokusfmcboxapp");
      req.postData = Stringify(payload);

      var resp = req.send();
      var status = resp.statusCode;

      if (status >= 200 && status < 300) {
        resultOk = true;
        resultMsg = "Upload successful!";
        // If you want: parse fileId
        // var json = Platform.Function.ParseJSON(resp.content);
        // resultMsg = "Upload successful! FileId: " + json.fileId;
      } else {
        resultMsg = "Upload failed. Status " + status + ". " + resp.content;
      }
    } catch (e) {
      resultMsg = "Error: " + String(e);
    }
  }
</script>


<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Upload Images to App Box</title>
    <meta name="description" content="%%=v(@SurveyDescription)=%%" />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css'>
    <link rel="stylesheet" href="https://mc44xj67dmqjm3p127xlr44g8ttq.pub.sfmc-content.com/exannc0jl1m">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <style>
      html {
        min-height:100%;
        position: relative;
        
        }

      body {
        font-size: 16px !important;

      }    

      #fc-other, #fc-other-radio  {
        display: none;
      }

      input[type='radio'] {
        accent-color: #00487a;
        width: 18px;
        height: 18px;
        border-radius: 18px;
        }

      input[type='radio']:hover {
        accent-color: #146cab;
        }

      .white-container {
        margin-bottom: 30px;
      }

      .alert-success {
        text-align: center;
      }

      .Ratingbutton {
        padding: 5px 10px;
        margin-right: 2px;
        border-radius: 50%;
        font-weight: bold;
      }

      @media only screen and (min-width: 992px) {
        .alert-success {
        text-align: left;
      }

      .Ratingbutton {
      padding: 15px 20px;
      margin-right: 5px;
      }
      }
    </style>

    <!-- Upload Image CSS -->
     <style>
        input[type="file"] {
        position: relative;
        font-size: 14px;
        }

        input[type="file"]::file-selector-button {
        width: 136px;
        color: transparent;
        }

        /* Faked label styles and icon */
        input[type="file"]::before {
        position: absolute;
        pointer-events: none;
        top: 10px;
        left: 16px;
        height: 20px;
        width: 20px;
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230964B0'%3E%3Cpath d='M18 15v3H6v-3H4v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2zM7 9l1.41 1.41L11 7.83V16h2V7.83l2.59 2.58L17 9l-5-5-5 5z'/%3E%3C/svg%3E");
        }

        input[type="file"]::after {
        position: absolute;
        pointer-events: none;
        top: 11px;
        left: 40px;
        color: #0964b0;
        content: "Upload File";
        }

        /* ------- From Step 1 ------- */

        /* file upload button */
        input[type="file"]::file-selector-button {
        border-radius: 4px;
        padding: 0 16px;
        height: 40px;
        cursor: pointer;
        background-color: white;
        border: 1px solid rgba(0, 0, 0, 0.16);
        box-shadow: 0px 1px 0px rgba(0, 0, 0, 0.05);
        margin-right: 16px;
        transition: background-color 200ms;
        }

        /* file upload button hover state */
        input[type="file"]::file-selector-button:hover {
        background-color: #f3f4f6;
        }

        /* file upload button active state */
        input[type="file"]::file-selector-button:active {
        background-color: #e5e7eb;
        }

        /* ------------------------ */


     </style>



    <link rel="icon" href="https://www.msrenewal.com/favicon-32x32.png">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body  > 

    <!-- Loading Bar -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 100%; background-color: #00487a !important" 
            aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
          </div>      
       </div>
      </div>
    </div>
     <!--End of Loading Bar -->

    <!-- Header -->
    <div class="container-fluid">
        <div class="row d-flex justify-content-center">
          <div class="col-12 text-center p-4 mb-4 ">
              <img class="logo" src="https://image.sfdc.msrenewal.com/lib/fe3b11717164047e771673/m/1/df563624-015b-4b07-aab0-e4c85e3b3219.png" alt="MSR" >
          </div>
          <div>
          </div>
        </div>
    </div>
    <!-- End of Header -->


    <!-- Upload Image Form -->
    <div class="container">
      <div class="row d-flex justify-content-center">
          <div class="col-11 col-md-8 white-container " >      
            <label >Upload a Picture of yourself and your family in your house!</label><br>


            <form id="uploadForm" method="post" >
                <!--<div class="mb-3">
                    <label for="exampleInputEmail1" class="form-label">Full Name:</label>
                    <input type="text" name="fullname"  style="border: 1px solid #00487a; width: 100%;max-width:400px; border-radius:5px;display:block" id="fullname" required>
                </div>-->

                  <div class="mb-3">
                    <label for="exampleInputEmail1" class="form-label">Upload Picture:</label><br>
                    <input id="file" type="file" name="file" accept="image/jpeg,image/png" required>
                </div>




              <input type="hidden" name="success" value="true">
                  <!-- Hidden fields populated on submit -->
              <input type="hidden" name="fileName" id="fileName">
              <input type="hidden" name="mimeType" id="mimeType">
              <input type="hidden" name="fileBase64" id="fileBase64">

              <div class="text-center">
                <button id="submitBtn" type="submit" class=" mt-4 submit submitactive">SUBMIT</button>
              </div>
              <span id="msg" style="margin-left:10px;"></span>
          </form>

                        <!-- Show result after POST -->
          <div id="serverResult" style="margin: 10px 0; font-weight: bold;">
            <script runat="server">
              if (isPost) {
                Write(resultOk ? "<span style='color:green;'>" : "<span style='color:red;'>");
                Write(String(resultMsg));
                Write("</span>");
              }
            </script>
          </div>

          </div>
      </div>

  <script>
    const form = document.getElementById("uploadForm");
    const btn  = document.getElementById("submitBtn");
    const msg  = document.getElementById("msg");

    const MAX_DIM = 1600;     // adjust (1200–2000 are common)
    const JPEG_Q  = 0.75;     // 0.6–0.85 typical sweet spot
    const MAX_OUT_BYTES = 10 * 1024 * 1024; // still enforce

    function safeBase(name) {
      return (name || "upload")
        .replace(/\.[^/.]+$/, "")
        .replace(/[^\w.\-]+/g, "_")
        .replace(/^\.+/, "")
        .slice(0, 80);
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function loadImage(dataUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    function canvasToDataURL(canvas, mime, quality) {
      return canvas.toDataURL(mime, quality); // returns data:mime;base64,...
    }

    async function compressImageToJpegDataURL(file) {
      // Read original
      const dataUrl = await fileToDataURL(file);
      const img = await loadImage(dataUrl);

      // Compute resize
      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;

      if (!w || !h) throw new Error("Invalid image dimensions");

      const scale = Math.min(1, MAX_DIM / Math.max(w, h));
      const nw = Math.max(1, Math.round(w * scale));
      const nh = Math.max(1, Math.round(h * scale));

      // Draw to canvas
      const canvas = document.createElement("canvas");
      canvas.width = nw;
      canvas.height = nh;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, nw, nh);

      // Always output JPEG for speed/size (unless you truly need PNG transparency)
      const outDataUrl = canvasToDataURL(canvas, "image/jpeg", JPEG_Q);
      return outDataUrl;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const f = document.getElementById("file").files?.[0];
      if (!f) return;

      // Only allow jpg/png inputs
      if (!(f.type === "image/jpeg" || f.type === "image/png")) {
        msg.textContent = "Please upload a JPG/JPEG or PNG.";
        return;
      }

      btn.disabled = true;
      msg.textContent = "Optimizing image...";

      try {
        const outDataUrl = await compressImageToJpegDataURL(f);

        // Extract base64 payload
        const base64 = outDataUrl.split(",")[1] || "";
        if (!base64) throw new Error("Failed to encode image");

        // Rough size check: base64 length * 0.75 ≈ bytes
        const approxBytes = Math.floor(base64.length * 0.75);
        if (approxBytes > MAX_OUT_BYTES) throw new Error("Output too large");

        // Name it as JPG since we output JPEG
        const newName = `${safeBase(f.name)}.jpg`;

        document.getElementById("fileName").value = newName;
        document.getElementById("mimeType").value = "image/jpeg";
        document.getElementById("fileBase64").value = base64;

        msg.textContent = "Uploading...";
        form.submit(); // triggers SSJS
      } catch (err) {
        btn.disabled = false;
        msg.textContent = "Image optimization failed. Try a smaller photo.";
        console.log(err);
      }
    });
  </script>






    </body>
  <!-- Upload Image Form -->
</html>
    







